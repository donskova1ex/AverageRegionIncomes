# Average Region Incomes

Сервис для обработки и анализа данных о средних доходах по регионам России. Система автоматически загружает данные с сайта Росстата, обрабатывает их и предоставляет API для доступа к информации.

## Описание системы

Система состоит из двух основных компонентов:
1. **Reader сервис** - отвечает за:
   - Автоматическую загрузку Excel-файлов с сайта Росстата
   - Обработку и парсинг данных из Excel
   - Сохранение данных в базу данных
   - Периодическое обновление данных по расписанию

2. **API сервер** - предоставляет REST API для:
   - Получения данных о средних доходах по регионам
   - Фильтрации данных по году и кварталу
   - Агрегации и анализа данных

## Структура проекта

```
.
├── api/                    # API endpoints и обработчики
├── cmd/                    # Точки входа приложений
│   ├── api/               # API сервер
│   └── readers/           # Сервис чтения данных
├── internal/              # Внутренняя логика приложения
│   ├── config/           # Конфигурация приложения
│   ├── domain/           # Бизнес-модели и интерфейсы
│   ├── middleware/       # HTTP middleware
│   ├── processors/       # Обработчики данных
│   └── repositories/     # Слой доступа к данным
├── migrations/           # SQL миграции базы данных
├── openapi/             # OpenAPI спецификации
├── specs/               # Технические спецификации
├── files/              # Директория для файлов данных
├── db-files/           # Файлы базы данных
├── tools/              # Утилиты для обработки данных
└── config/             # Конфигурационные файлы
```

### Ключевые компоненты

#### Reader сервис (`cmd/readers/`)
- Автоматическая загрузка файлов с сайта Росстата
- Парсинг Excel-файлов с данными
- Сохранение данных в PostgreSQL
- Периодическое обновление по расписанию
- Обработка ошибок и повторные попытки

#### API сервер (`cmd/api/`)
- REST API для доступа к данным
- Кэширование в Redis
- Метрики и логирование
- Graceful shutdown

#### Репозитории (`internal/repositories/`)
- `SQLRepository` - работа с PostgreSQL
- `ExcelReader` - чтение Excel-файлов
- `RedisRepository` - кэширование в Redis

#### Процессоры (`internal/processors/`)
- Обработка и валидация данных
- Бизнес-логика приложения
- Агрегация данных

#### Утилиты (`tools/`)
- `file_changer.go` - инструменты для обработки Excel-файлов
  - Форматирование заголовков
  - Удаление служебной информации
  - Преобразование данных в структурированный формат

## Технологический стек

- **Язык программирования**: Go 1.23
- **База данных**: PostgreSQL 15
- **Кэширование**: Redis
- **Контейнеризация**: Docker & Docker Compose
- **Маршрутизация**: Gorilla Mux
- **Работа с БД**: SQLx
- **Excel**: Excelize
- **Логирование**: slog
- **Конфигурация**: godotenv

## Запуск проекта

### Разработка

```bash
# Запуск всех сервисов
docker-compose -f docker-compose.dev.yaml up

# Только миграции
docker-compose -f docker-compose.dev.yaml up migrations-up

# Откат миграций
docker-compose -f docker-compose.dev.yaml --profile migrations-down up migrations-down
```

### Переменные окружения

Основные переменные находятся в `config/.env.dev`:

#### PostgreSQL
- `POSTGRES_DSN` - строка подключения к базе данных
- `POSTGRES_USER` - пользователь базы данных
- `POSTGRES_PASSWORD` - пароль
- `POSTGRES_DB` - имя базы данных

#### API сервер
- `API_PORT` - порт для API сервера
- `API_HOST` - хост для API сервера

#### Reader сервис
- `READER_NAME` - имя контейнера
- `READER_MAIN_DIR` - основная директория
- `READER_CONTAINER_DIR` - директория в контейнере
- `DEFAULT_FILE_PATH` - путь к файлу по умолчанию
- `PARSING_INTERVAL` - интервал обновления данных
- `MAX_RETRIES` - максимальное количество попыток
- `SSL_COOKIE_URL` - URL для получения cookies
- `FILE_STORAGE_URL` - URL хранилища файлов

## API Документация

API документация доступна в формате OpenAPI в директории `openapi/`. Основные эндпоинты:

- `GET /api/v1/regionincomes` - получение данных о доходах
  - Параметры:
    - `regionid` (обязательный) - ID региона
    - `year` (опциональный) - год
    - `quarter` (опциональный) - квартал

## Разработка

### Требования
- Go 1.23+
- Docker & Docker Compose
- Make

### Сборка
```bash
# Сборка всех компонентов
make dev-build

# Сборка API сервера
make dev-build-api

# Сборка Reader сервиса
make dev-build-reader
```

### Тестирование
```bash
# Запуск всех тестов
make test

# Запуск линтера
make lint
```

## Архитектура

Проект следует принципам чистой архитектуры:

1. **Слои приложения**:
   - API Layer (handlers)
   - Service Layer (business logic)
   - Repository Layer (data access)
   - Domain Layer (entities and interfaces)

2. **Принципы**:
   - Dependency Injection
   - Interface Segregation
   - Single Responsibility
   - Open/Closed Principle

3. **Обработка данных**:
   - Валидация входных данных
   - Транзакционность операций
   - Кэширование результатов
   - Обработка ошибок

4. **Мониторинг**:
   - Метрики производительности
   - Логирование операций
   - Трейсинг запросов
   - Алертинг
